# .github/workflows/ios.yml
name: Build & Upload iOS

on:
  push:
    branches:
      - master

jobs:
  ios-build:
    runs-on: macos-latest

    steps:
      # ─────────────────────────────────────────────────────────────────────────
      # 1️⃣  Check out your repository
      # ─────────────────────────────────────────────────────────────────────────
      - name: ▶️ Checkout code
        uses: actions/checkout@v4


      # ─────────────────────────────────────────────────────────────────────────
      # 2️⃣  Decode your three Base64‐encoded secrets into actual files
      #    • ${{ secrets.P12_BASE64 }} → signing.p12
      #    • ${{ secrets.PROFILE_BASE64 }} → app.mobileprovision
      #    • ${{ secrets.ASC_KEY_BASE64 }} → asc_key.p8
      # ─────────────────────────────────────────────────────────────────────────
      - name: Decode iOS signing artifacts
        run: |
          echo "$P12_BASE64"      | base64 --decode > signing.p12
          echo "$PROFILE_BASE64"  | base64 --decode > app.mobileprovision
          echo "$ASC_KEY_BASE64"  | base64 --decode > asc_key.p8
        env:
          P12_BASE64:     ${{ secrets.P12_BASE64 }}
          PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}
          ASC_KEY_BASE64: ${{ secrets.ASC_KEY_BASE64 }}


      # ─────────────────────────────────────────────────────────────────────────
      # 3️⃣  Import your Distribution certificate (signing.p12) into a
      #    throw-away keychain.  The apple-actions/import-codesign-certs@v2
      #    action will:
      #      • create a temp keychain
      #      • import signing.p12 (using P12_PASSWORD)
      #      • expose `steps.import-certs.outputs.keychain-path`
      #      • clean up the keychain at the end of the job automatically
      # ─────────────────────────────────────────────────────────────────────────
      - name: Import Apple Distribution certificate 🗝️
        id: import-certs
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-filepath: signing.p12
          p12-password: ${{ secrets.P12_PASSWORD }}


      # ─────────────────────────────────────────────────────────────────────────
      # 4️⃣  Install your provisioning profile
      #      • Decode the CMS wrapper to plist → extract its UUID
      #      • Place the .mobileprovision into ~/Library/MobileDevice/Provisioning Profiles/<UUID>.mobileprovision
      #      • Export the UUID into $GITHUB_ENV so we can reference it in msbuild
      # ─────────────────────────────────────────────────────────────────────────
      - name: Install provisioning profile 📦
        id: install-profile
        run: |
          # Decode the mobileprovision to a temporary .plist so we can read its UUID
          security cms -D -i app.mobileprovision -o profile.plist

          # Extract the UUID
          uuid=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist)

          # Create the directory where Xcode expects provisioning profiles
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          # Copy the actual .mobileprovision into that folder, named by UUID
          cp app.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$uuid.mobileprovision"

          # Expose the UUID as an environment variable for later
          echo "IOS_PROFILE_UUID=$uuid" >> "$GITHUB_ENV"

          echo "✅ Installed provisioning profile at $uuid.mobileprovision"
      

      # ─────────────────────────────────────────────────────────────────────────
      # 5️⃣  Install the exact .NET 8.0 SDK you pinned in global.json
      # ─────────────────────────────────────────────────────────────────────────
      - name: Setup .NET SDK 8.0 .301
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.301'


      # ─────────────────────────────────────────────────────────────────────────
      # 6️⃣  Pin and install exactly the MAUI iOS workload (only iOS, NOT Woofer-all MAUI)
      # ─────────────────────────────────────────────────────────────────────────
      - name: Install maui-ios workload (v17.4.0)
        run: dotnet workload install maui-ios --version 17.4.0


      # ─────────────────────────────────────────────────────────────────────────
      # 7️⃣  Build & sign your .IPA
      #
      #    • "dotnet publish" automatically does a restore (no need for a separate dotnet restore).
      #    • We pass /p:BuildIpa=true & /p:CodesignKeychain=… & /p:CodesignProvision=…  
      #    • The friendly name for your distribution certificate (as shown in your Apple Developer portal)
      #      must exactly match. In your case: "Apple Distribution: rylan champion (YUDP2VB9YY)"
      #    • We read the temporary keychain path from ${{ steps.import-certs.outputs.keychain-path }}  
      #    • We read the provisioning-profile UUID from ${{ env.IOS_PROFILE_UUID }}  
      # ─────────────────────────────────────────────────────────────────────────
      - name: Publish .NET MAUI iOS → .ipa
        run: |
          dotnet publish ./AlanJayApp.csproj \
            -c Release \
            -f net8.0-ios \
            -r ios-arm64 \
            -o out \
            /p:BuildIpa=true \
            /p:CodesignKey="Apple Distribution: rylan champion (YUDP2VB9YY)" \
            /p:CodesignKeychain="${{ steps.import-certs.outputs.keychain-path }}" \
            /p:CodesignProvision="${{ env.IOS_PROFILE_UUID }}" \
            /p:PublishTrimmed=true \
            /p:MtouchLink=SdkOnly

      - name: List IPA output folder 🔍
        run: |
          echo "────── out/ contents ──────"
          ls -l out
          echo "───────────────────────────"


      # ─────────────────────────────────────────────────────────────────────────
      # 8️⃣  Setup Ruby + Fastlane (via Bundler)
      # ─────────────────────────────────────────────────────────────────────────
      - name: Setup Ruby & Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true


      # ─────────────────────────────────────────────────────────────────────────
      # 9️⃣  Upload that .IPA to TestFlight / App Store Connect using Fastlane
      #
      #    We tell fastlane three environment variables:
      #      • APP_STORE_CONNECT_API_KEY_KEY   = your Key ID (e.g. CVUBTX49V8)
      #      • APP_STORE_CONNECT_API_KEY_ISSUER_ID = your Issuer ID (GUID)
      #      • APP_STORE_CONNECT_API_KEY_CONTENT (Base64 payload of asc_key.p8)
      #      • And we set APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64=true  
      #
      #    Internally, fastlane sees `--api_key_path` or `ENV[“APP_STORE_CONNECT_API_KEY_CONTENT”]` and uses that Key to authenticate.
      # ─────────────────────────────────────────────────────────────────────────
      - name: Deliver to App Store Connect 🚀
        uses: maierj/fastlane-action@v3
        with:
          lane: deliver
        env:
          # Key ID (“ASC_KEY_ID” → e.g. CVUBTX49V8)
          APP_STORE_CONNECT_API_KEY_KEY:       ${{ secrets.ASC_KEY_ID }}
          # Issuer ID (32-char GUID)
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          # We’re supplying the .p8 contents as Base64:
          APP_STORE_CONNECT_API_KEY_CONTENT:         ${{ secrets.ASC_KEY_BASE64 }}
          APP_STORE_CONNECT_API_KEY_IS_KEY_CONTENT_BASE64: 'true'
