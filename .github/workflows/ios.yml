name: Build & Upload iOS

on:
  push:
    branches: [ master ]

jobs:
  ios-build:
    runs-on: macos-latest

    steps:
      # ─────────────────────────────────────────────────────────────────────────────
      # 1️⃣ SHOW RUNNER / XCODE / DOTNET VERSIONS (for debugging)
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Env / tool versions 🔍
        run: |
          sw_vers
          xcodebuild -version | head -1
          dotnet --info

      # ─────────────────────────────────────────────────────────────────────────────
      # 2️⃣ CHECK OUT YOUR CODE
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Checkout source
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────────────────────
      # 3️⃣ INSTALL .NET 8.0.301
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Use .NET 8.0.301
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.301

      # ─────────────────────────────────────────────────────────────────────────────
      # 4️⃣ DECODE & SAVE SIGNING ARTIFACTS (from repository Secrets)
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Restore signing files
        run: |
          echo "${{ secrets.P12_BASE64 }}"     | base64 --decode > signing.p12
          echo "${{ secrets.PROFILE_BASE64 }}" | base64 --decode > app.mobileprovision
          echo "${{ secrets.ASC_KEY_BASE64 }}"  | base64 --decode > asc_key.p8
        env:
          P12_BASE64:     ${{ secrets.P12_BASE64 }}
          PROFILE_BASE64: ${{ secrets.PROFILE_BASE64 }}
          ASC_KEY_BASE64: ${{ secrets.ASC_KEY_BASE64 }}

      # ─────────────────────────────────────────────────────────────────────────────
      # 5️⃣ IMPORT .p12 INTO A TEMP KEYCHAIN
      # ─────────────────────────────────────────────────────────────────────────────
      - id: import-certs
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-filepath: signing.p12
          p12-password: ${{ secrets.P12_PASSWORD }}

      - name: List keychain identities 🔍
        run: security find-identity -p codesigning -v

      # ─────────────────────────────────────────────────────────────────────────────
      # 6️⃣ INSTALL .mobileprovision INTO XCODE’S PROFILES FOLDER
      # ─────────────────────────────────────────────────────────────────────────────
      - id: install-profile
        run: |
          security cms -D -i app.mobileprovision -o tmp.plist
          uuid=$(/usr/libexec/PlistBuddy -c 'Print :UUID' tmp.plist)
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp app.mobileprovision \
            "$HOME/Library/MobileDevice/Provisioning Profiles/$uuid.mobileprovision"
          echo "UUID=$uuid" >> "$GITHUB_ENV"

      # ─────────────────────────────────────────────────────────────────────────────
      # 7️⃣ CACHE NuGet PACKAGES & .dotnet WORKLOADS
      #    (so that `dotnet workload install` doesn’t re-download every run)
      # ─────────────────────────────────────────────────────────────────────────────
      - uses: actions/cache@v3
        with:
          path: |
            ~/.nuget/packages
            ~/.dotnet/workloads
            ~/.dotnet/tools
          key: ${{ runner.os }}-dotnet-cache-${{ hashFiles('**/global.json','**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-cache-

      # ─────────────────────────────────────────────────────────────────────────────
      # 8️⃣ RESTORE ALL WORKLOADS (picks up pin in global.json → maui-ios@17.4.0)
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Restore .NET workloads
        run: dotnet workload restore

      # ─────────────────────────────────────────────────────────────────────────────
      # 9️⃣ PIN & INSTALL EXACTLY maui-ios 17.4.0
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Pin & install maui-ios
        run: dotnet workload install maui-ios --version 17.4.0

      # ─────────────────────────────────────────────────────────────────────────────
      # 🔟 RESTORE ONLY iOS ASSETS (skip Android entirely)
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Restore iOS assets only
        run: |
          dotnet restore ./AlanJayApp.csproj \
            -p:TargetFramework=net8.0-ios \
            -p:RuntimeIdentifier=ios-arm64

      # ─────────────────────────────────────────────────────────────────────────────
      # 1️⃣1️⃣ PUBLISH YOUR .IPA
      #    • Uses “Apple Distribution: rylan champion (YUDP2VB9YY)” from the temp keychain  
      #    • Sets MtouchLink=SdkOnly (“Link Framework SDKs Only”) so you don’t need Xcode 16  
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Publish .NET MAUI for iOS
        run: |
          dotnet publish ./AlanJayApp.csproj \
            --configuration Release \
            --framework net8.0-ios \
            --runtime ios-arm64 \
            --output out \
            --no-restore \
            /p:BuildIpa=true \
            /p:CodesignKey="Apple Distribution: rylan champion (YUDP2VB9YY)" \
            /p:CodesignKeychain="${{ steps.import-certs.outputs.keychain-path }}" \
            /p:CodesignProvision="${{ env.UUID }}" \
            /p:MtouchLink=SdkOnly

      - name: List publish output 🔍
        run: ls -l out

      # ─────────────────────────────────────────────────────────────────────────────
      # 1️⃣2️⃣ INSTALL RUBY & FASTLANE (v1 gem, cached by bundler-cache)
      # ─────────────────────────────────────────────────────────────────────────────
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # ─────────────────────────────────────────────────────────────────────────────
      # 1️⃣3️⃣ DELIVER TO TESTFLIGHT VIA FASTLANE
      #    • asc_key.p8 was already decoded in step 4 as “asc_key.p8” in the workspace root
      # ─────────────────────────────────────────────────────────────────────────────
      - name: Deliver to App Store Connect
        env:
          APP_STORE_CONNECT_API_KEY_KEY:       ${{ secrets.ASC_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        run: |
          gem install fastlane
          fastlane deliver \
            --ipa out/AlanJayApp.ipa \
            --api_key_path asc_key.p8 \
            --issuer_id ${{ secrets.ASC_ISSUER_ID }} \
            --key_id    ${{ secrets.ASC_KEY_ID }}
